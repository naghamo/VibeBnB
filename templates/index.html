{% extends "base.html" %}
{% block content %}

<h2 class="section-title">Select a reference listing</h2>
<p class="muted">
  Search in the table, click a row to select a listing, then set your preferences and run “Find Similar”.
</p>

<div class="toolbar">
  <div class="searchbox">
    <label class="label" for="searchInput">Search</label>
    <input id="searchInput" class="input" type="text"
           placeholder="Type to filter listings (title, city, country, id)…">
  </div>

  <div class="selectedbox">
    <div class="label">Selected listing</div>
    <div id="selectedDisplay" class="selected-pill">None</div>
  </div>
</div>

<div class="table-wrap">
  <table id="listingsTable" class="table">
    <thead>
      <tr>
        <th>ID</th>
        <th>Title</th>
        <th>Type</th>
        <th>City</th>
        <th>Country</th>
        <th>Price</th>
        <th>Rating</th>
      </tr>
    </thead>
    <tbody>
      {% for r in listings %}
      <tr class="row" data-id="{{ r.property_id }}">
        <td>{{ r.property_id }}</td>
        <td>{{ r.listing_title }}</td>
        <td>{{ r.room_type_text }}</td>
        <td>{{ r.addr_name }}</td>
        <td>{{ r.addr_cc }}</td>
        <td>{{ r.price_per_night }}</td>
        <td>{{ r.ratings }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<hr class="divider">

<h2 class="section-title">Find similar listings</h2>

<form method="POST" class="form">
  <input type="hidden" name="selected_listing_id" id="selectedListingId" value="">

  <div class="grid">
    <div class="field">
      <label class="label" for="target_country">Filter candidates by country</label>
      <select class="select" name="target_country" id="target_country">
        <!-- <option value="">No filter (global)</option> -->
        {% for c in countries %}
          <option value="{{ c }}">{{ c }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="field">
      <label class="label" for="n_candidates">Similarity depth (retrieve N candidates)</label>
      <select class="select" name="n_candidates" id="n_candidates">
        {% for val in [25, 50, 100, 200] %}
          <option value="{{ val }}" {% if val == 50 %}selected{% endif %}>{{ val }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="field">
      <label class="label" for="k">Show top k after ranking</label>
      <select class="select" name="k" id="k">
        {% for val in [5, 10, 15, 20] %}
          <option value="{{ val }}" {% if val == 10 %}selected{% endif %}>{{ val }}</option>
        {% endfor %}
      </select>
    </div>
  </div>

  <div class="prefs">
    <div class="prefs-title">Core Weights (0–100)</div>

    <div class="prefs-grid">
      <div class="pref">
        <div class="pref-head">
          <span>Price importance</span>
          <span id="priceVal" class="pref-val">25</span>
        </div>
        <input type="range" min="0" max="100" value="25" name="w_price" id="w_price">
      </div>

      <div class="pref">
        <div class="pref-head">
          <span>Property quality importance</span>
          <span id="propVal" class="pref-val">25</span>
        </div>
        <input type="range" min="0" max="100" value="25" name="w_property" id="w_property">
      </div>

      <div class="pref">
        <div class="pref-head">
          <span>Host quality importance</span>
          <span id="hostVal" class="pref-val">25</span>
        </div>
        <input type="range" min="0" max="100" value="25" name="w_host" id="w_host">
      </div>

      <div class="pref">
        <div class="pref-head">
          <span>Environment importance (overall)</span>
          <span class="pref-val muted">Set per category below</span>
        </div>
        <div class="muted small">Use the category sliders (Food, Nature, etc.)</div>
      </div>
    </div>

    <hr class="divider" style="margin:14px 0;">

    <div class="prefs-title">City Context (optional)</div>

    <div class="grid">
      <div class="field">
        <label class="label" for="travel_month">Travel month (1–12)</label>
        <input class="input" type="number" min="1" max="12" value="7" name="travel_month" id="travel_month">
      </div>

      <div class="field">
        <label class="label" for="temp_pref">Preferred temperature (°C)</label>
        <input class="input" type="number" step="0.5" value="22" name="temp_pref" id="temp_pref">
      </div>

      <div class="field">
        <label class="label" for="budget_pref">Budget preference</label>
        <select class="select" name="budget_pref" id="budget_pref">
          <option value="">No preference</option>
          {% for b in budget_choices %}
            <option value="{{ b }}">{{ b }}</option>
          {% endfor %}
        </select>
      </div>
    </div>

    <div class="prefs-grid" style="margin-top:12px;">
      <div class="pref">
        <div class="pref-head">
          <span>Temperature weight</span>
          <span id="tempWVal" class="pref-val">0</span>
        </div>
        <input type="range" min="0" max="100" value="0" name="w_temp" id="w_temp">
      </div>

      <div class="pref">
        <div class="pref-head">
          <span>Budget weight</span>
          <span id="budgetWVal" class="pref-val">0</span>
        </div>
        <input type="range" min="0" max="100" value="0" name="w_budget" id="w_budget">
      </div>
    </div>

    {% if env_choices and env_choices|length > 0 %}
    <hr class="divider" style="margin:14px 0;">
    <div class="prefs-title">Environment Category Weights (0–100)</div>

    <div class="prefs-grid">
      {% for c in env_choices %}
      <div class="pref">
        <div class="pref-head">
          <span>{{ c.replace("env_", "").replace("_norm", "").replace("_", " ") | title }}</span>
          <span id="val_{{ c }}" class="pref-val">0</span>
        </div>
        <input type="range" min="0" max="100" value="0" name="w_{{ c }}" id="w_{{ c }}">
      </div>
      {% endfor %}
    </div>
    {% endif %}

    <p class="muted small" style="margin-top:10px;">
      All positive weights are normalized to sum to 1 inside the ranking function.
    </p>
  </div>

  <div class="actions">
    <button type="submit" class="btn">Find Similar</button>
    <button type="button" class="btn secondary" id="clearSelection">Clear selection</button>
  </div>
</form>

{% if result %}
  <div class="result">
    <div class="result-title">Status</div>
    <div class="result-body">{{ result }}</div>
  </div>
{% endif %}

{% if target_row %}
  <div class="result" style="margin-top:12px;">
    <div class="result-title">Target listing</div>
    <div class="result-body">
ID: {{ target_row.property_id }} | {{ target_row.addr_cc }} | {{ target_row.addr_name }}
Title: {{ target_row.listing_title }}
Type: {{ target_row.room_type_text }} | Price: {{ target_row.price_per_night }} | Rating: {{ target_row.ratings }}
    </div>
  </div>
{% endif %}

{% if results_rows %}
  <h2 class="section-title" style="margin-top:16px;">Top results</h2>
  <div class="table-wrap">
    <table class="table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Country</th>
          <th>City</th>
          <th>Title</th>
          <th>Type</th>
          <th>Price</th>
          <th>Rating</th>
          <th>l2_dist</th>
          <th>final_score</th>
        </tr>
      </thead>
      <tbody>
        {% for r in results_rows %}
        <tr>
          <td>{{ r.property_id }}</td>
          <td>{{ r.addr_cc }}</td>
          <td>{{ r.addr_name }}</td>
          <td>{{ r.listing_title }}</td>
          <td>{{ r.room_type_text }}</td>
          <td>{{ r.price_per_night }}</td>
          <td>{{ r.ratings }}</td>
          <td>{{ "%.4f"|format(r.l2_dist) if r.l2_dist is not none else "" }}</td>
          <td>{{ "%.4f"|format(r.final_score) if r.final_score is not none else "" }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
{% endif %}

{% endblock %}

{% block scripts %}
<script>
  // --- Table search ---
  const searchInput = document.getElementById("searchInput");
  const table = document.getElementById("listingsTable");
  const rows = Array.from(table.querySelectorAll("tbody tr"));

  searchInput.addEventListener("input", () => {
    const q = searchInput.value.toLowerCase();
    rows.forEach(r => {
      const text = r.innerText.toLowerCase();
      r.style.display = text.includes(q) ? "" : "none";
    });
  });

  // --- Row selection ---
  const selectedDisplay = document.getElementById("selectedDisplay");
  const selectedListingId = document.getElementById("selectedListingId");
  let selectedRow = null;

  rows.forEach(r => {
    r.addEventListener("click", () => {
      if (selectedRow) selectedRow.classList.remove("selected");
      selectedRow = r;
      r.classList.add("selected");
      const id = r.getAttribute("data-id");
      selectedListingId.value = id;
      selectedDisplay.textContent = "Listing ID: " + id;
    });
  });

  document.getElementById("clearSelection").addEventListener("click", () => {
    if (selectedRow) selectedRow.classList.remove("selected");
    selectedRow = null;
    selectedListingId.value = "";
    selectedDisplay.textContent = "None";
  });

  function bindRange(rangeId, labelId) {
    const range = document.getElementById(rangeId);
    const label = document.getElementById(labelId);
    if (!range || !label) return;
    const update = () => label.textContent = range.value;
    range.addEventListener("input", update);
    update();
  }

  bindRange("w_price", "priceVal");
  bindRange("w_property", "propVal");
  bindRange("w_host", "hostVal");
  bindRange("w_temp", "tempWVal");
  bindRange("w_budget", "budgetWVal");

  // env sliders
  {% for c in env_choices %}
    bindRange("w_{{ c }}", "val_{{ c }}");
  {% endfor %}
</script>
{% endblock %}
